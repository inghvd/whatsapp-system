<!DOCTYPE html>
<html>
<head>
    <title>Panel WhatsApp</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-5">
    <div class="container bg-white p-4 rounded shadow">
        <h2 class="text-center mb-4">ðŸ¤– Panel de Control</h2>

        <div class="row">
            <!-- COLUMNA 1: QR -->
            <div class="col-md-4 text-center border-end">
                <h4>1. ConexiÃ³n</h4>
                <div id="qrArea" class="mt-3">
                    <div class="spinner-border text-primary"></div>
                    <p>Conectando...</p>
                </div>
            </div>

            <!-- COLUMNA 2: CONTACTOS -->
            <div class="col-md-4 border-end">
                <h4>2. Contactos</h4>
                <input id="name" class="form-control mb-2" placeholder="Nombre">
                <input id="phone" class="form-control mb-2" placeholder="TelÃ©fono (Ej: 595...)">
                <button onclick="saveContact()" class="btn btn-warning w-100">Guardar Contacto</button>
                
                <hr>
                <h6>Lista Guardada (<span id="count">0</span>):</h6>
                <ul id="contactList" class="list-group small" style="max-height: 200px; overflow: auto;">
                    <!-- AquÃ­ aparecerÃ¡n -->
                </ul>
            </div>

            <!-- COLUMNA 3: ENVIAR -->
            <div class="col-md-4">
                <h4>3. CampaÃ±a</h4>
                <textarea id="msg" class="form-control mb-2" placeholder="Hola {name}..."></textarea>
                <button onclick="sendCampaign()" class="btn btn-primary w-100">ðŸš€ Enviar</button>
            </div>
        </div>

        <div class="mt-4 p-3 bg-dark text-white rounded">
            <h6>Monitor:</h6>
            <div id="logs" style="height: 100px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        const socket = io();

        // Cargar contactos al iniciar
        loadContacts();

        async function saveContact() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            
            if(!name || !phone) return alert("Completa los datos");

            const res = await fetch('/save-contact', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, phone })
            });
            const data = await res.json();
            
            if(data.status === 'Guardado') {
                alert("âœ… Contacto Guardado");
                loadContacts(); // Recargar lista visualmente
                document.getElementById('name').value = '';
                document.getElementById('phone').value = '';
            } else {
                alert("âŒ Error al guardar: " + JSON.stringify(data));
            }
        }

        async function loadContacts() {
            const res = await fetch('/get-contacts');
            const data = await res.json();
            document.getElementById('count').innerText = data.length;
            
            const list = document.getElementById('contactList');
            list.innerHTML = '';
            data.forEach(c => {
                list.innerHTML += `<li class="list-group-item">${c.name} (${c.phone})</li>`;
            });
        }

        async function sendCampaign() {
            const message = document.getElementById('msg').value;
            if(confirm("Â¿Enviar a todos los contactos de la lista?")) {
                await fetch('/send-campaign', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message })
                });
            }
        }

        socket.on('qr', d => document.getElementById('qrArea').innerHTML = `<img src="${d.src}" width="200"><br>Escanea`);
        socket.on('ready', () => document.getElementById('qrArea').innerHTML = `<h1 class="text-success">âœ…</h1><p>Conectado</p>`);
        socket.on('log', d => document.getElementById('logs').innerHTML = `<div>${d.msg}</div>` + document.getElementById('logs').innerHTML);
    </script>
</body>
</html>
