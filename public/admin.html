<!DOCTYPE html>
<html>
<head>
    <title>Gerencia - Reportes WhatsApp</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-light p-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìä Panel Gerencial</h2>
            <div>
                <button onclick="window.location.href='/panel.html'" class="btn btn-outline-primary me-2">Ir a Operaciones</button>
                <button onclick="window.location.href='/login.html'" class="btn btn-danger">Salir</button>
            </div>
        </div>

        <!-- GESTI√ìN DE EQUIPO -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">üë• Gesti√≥n de Equipo</div>
            <div class="card-body">
                <!-- Crear Usuario con Rol -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="small">Usuario Nuevo</label>
                        <input id="newUser" class="form-control" placeholder="Ej: vendedor1">
                    </div>
                    <div class="col-md-4">
                        <label class="small">Contrase√±a</label>
                        <input id="newPass" type="password" class="form-control" placeholder="Ej: clave123">
                    </div>
                    <div class="col-md-2">
                        <label class="small">Rol</label>
                        <select id="newRole" class="form-select">
                            <option value="agent">Agente</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button onclick="createUser()" class="btn btn-success w-100">Crear Usuario</button>
                    </div>
                </div>

                <!-- Cambiar Contrase√±a -->
                <hr>
                <h5 class="text-primary mb-3">Cambiar Contrase√±a</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <input id="changeUser" class="form-control" placeholder="Nombre de usuario">
                    </div>
                    <div class="col-md-4">
                        <input id="changePass" type="password" class="form-control" placeholder="Nueva contrase√±a">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button onclick="changePassword()" class="btn btn-warning w-100">Cambiar</button>
                    </div>
                </div>
                <div id="msgChange" class="mt-2"></div>
            </div>
        </div>

        <!-- LISTA DE USUARIOS -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-info text-white">Usuarios Registrados</div>
            <div class="card-body">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Usuario</th>
                            <th>Rol</th>
                        </tr>
                    </thead>
                    <tbody id="userList">
                        <tr><td colspan="2" class="text-center text-muted">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- REPORTES -->
        <div class="card shadow-sm border-success">
            <div class="card-header bg-success text-white">üì• Generador de Reportes (Excel)</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="fw-bold">Fecha Inicio:</label>
                        <input type="date" id="dateStart" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="fw-bold">Fecha Fin:</label>
                        <input type="date" id="dateEnd" class="form-control">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button onclick="generarReporte()" class="btn btn-dark w-100">üîç Buscar y Exportar</button>
                    </div>
                </div>
                <hr>
                <h6>Vista Previa de Datos:</h6>
                <div style="height: 400px; overflow: auto; border: 1px solid #ccc;">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-dark" style="position: sticky; top: 0;">
                            <tr>
                                <th>Fecha</th>
                                <th>Usuario</th>
                                <th>Tipo</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                            <tr><td colspan="4" class="text-center text-muted py-4">Selecciona fechas para ver datos</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateStart').value = today;
        document.getElementById('dateEnd').value = today;

        // Cargar usuarios
        async function loadUsers() {
            try {
                const res = await fetch('/admin/get-users');
                const d = await res.json();
                const tbody = document.getElementById('userList');
                tbody.innerHTML = '';
                if (d.success && d.users.length > 0) {
                    d.users.forEach(u => {
                        tbody.innerHTML += `<tr><td><b>${u.username}</b></td><td>${u.role}</td></tr>`;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No hay usuarios</td></tr>';
                }
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-danger">Error al cargar</td></tr>';
            }
        }
        loadUsers();

        // Crear usuario (con rol)
        async function createUser() {
            const u = document.getElementById('newUser').value.trim();
            const p = document.getElementById('newPass').value;
            const role = document.getElementById('newRole').value;
            if (!u || !p) return alert("Completa usuario y contrase√±a");

            try {
                const res = await fetch('/admin/create-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p, role })
                });
                const d = await res.json();
                alert(d.success ? "‚úÖ " + d.message : "‚ùå " + (d.error || "Error"));
                if (d.success) {
                    document.getElementById('newUser').value = '';
                    document.getElementById('newPass').value = '';
                    loadUsers();
                }
            } catch (err) {
                alert("Error de conexi√≥n");
            }
        }

        // Cambiar contrase√±a
        async function changePassword() {
            const username = document.getElementById('changeUser').value.trim();
            const newPassword = document.getElementById('changePass').value;
            if (!username || !newPassword) return alert("Completa ambos campos");

            try {
                const res = await fetch('/admin/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, newPassword })
                });
                const d = await res.json();
                const msg = document.getElementById('msgChange');
                msg.innerHTML = d.success ? '<span class="text-success">‚úÖ Contrase√±a cambiada</span>' : '<span class="text-danger">‚ùå ' + (d.error || "Error") + '</span>';
                if (d.success) {
                    document.getElementById('changeUser').value = '';
                    document.getElementById('changePass').value = '';
                }
            } catch (err) {
                document.getElementById('msgChange').innerHTML = '<span class="text-danger">Error de conexi√≥n</span>';
            }
        }

        // Reportes (sin cambios)
        async function generarReporte() {
            const start = document.getElementById('dateStart').value;
            const end = document.getElementById('dateEnd').value;
            if (!start || !end) return alert("Selecciona ambas fechas");

            try {
                const res = await fetch(`/admin/export-logs?start=${start}&end=${end}`);
                const logs = await res.json();

                const tbody = document.getElementById('tbody');
                tbody.innerHTML = '';

                if (!logs || logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No hay registros en las fechas seleccionadas</td></tr>';
                    return;
                }

                logs.forEach(l => {
                    const fecha = new Date(l.timestamp).toLocaleString('es-ES');
                    tbody.innerHTML += `
                        <tr>
                            <td>${fecha}</td>
                            <td class="fw-bold">${l.username || 'Sistema'}</td>
                            <td><span class="badge bg-primary">${l.type || 'general'}</span></td>
                            <td class="small text-muted">${l.message}</td>
                        </tr>`;
                });

                if (confirm(`‚úÖ ${logs.length} registros encontrados.\n¬øDescargar Excel?`)) {
                    descargarExcel(logs);
                }
            } catch (err) {
                alert("Error al cargar reportes");
            }
        }

        function descargarExcel(data) {
            const ws = XLSX.utils.json_to_sheet(data.map(l => ({
                Fecha: new Date(l.timestamp).toLocaleString('es-ES'),
                Usuario: l.username || 'Sistema',
                Tipo: l.type || 'general',
                Mensaje: l.message
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte");
            const fecha = new Date().toISOString().slice(0,10);
            XLSX.writeFile(wb, `Reporte_WhatsApp_${fecha}.xlsx`);
        }
    </script>
</body>
</html>
